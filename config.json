{
  "_comment": "XOAUTH2 Proxy v2.0 - Global Configuration",
  "_version": "2.0",
  "_description": "Global settings and provider defaults. Account credentials are in accounts.json (separate file).",

  "_documentation": {
    "config_file": "This file (config.json) contains global settings and provider defaults",
    "accounts_file": "accounts.json contains account credentials (OAuth2, emails, etc.)",
    "cli_overrides": "CLI arguments (--host, --port, etc.) override these settings",
    "hot_reload": "Send SIGHUP signal (Unix) to reload configuration without restart"
  },

  "global": {
    "_description": "Global proxy settings that apply to all accounts",

    "concurrency": {
      "_description": "Concurrency and queue settings for the entire proxy",
      "global_concurrency_limit": 2000,
      "_global_concurrency_limit_doc": "Maximum concurrent messages across all accounts (default: 100, HIGH-VOLUME: 2000 for 70k msg/min)",

      "backpressure_queue_size": 5000,
      "_backpressure_queue_size_doc": "Maximum queued messages before rejecting new connections (default: 1000, HIGH-VOLUME: 5000)",

      "connection_backlog": 2048,
      "_connection_backlog_doc": "TCP backlog for incoming SMTP connections (default: 100, HIGH-VOLUME: 2048 matches OS net.core.somaxconn)"
    },

    "timeouts": {
      "_description": "Global timeout settings (in seconds)",

      "oauth2_timeout": 10,
      "_oauth2_timeout_doc": "Timeout for OAuth2 token refresh requests to Google/Microsoft (default: 10 seconds)",

      "connection_acquire_timeout": 5,
      "_connection_acquire_timeout_doc": "[DEPRECATED - Not used] Timeout for acquiring connection from pool (default: 5 seconds, replaced by per-connection timeouts)",

      "smtp_command_timeout": 300,
      "_smtp_command_timeout_doc": "Timeout for SMTP commands (default: 300 seconds / 5 minutes)",

      "smtp_data_timeout": 600,
      "_smtp_data_timeout_doc": "Timeout for DATA command (message upload) (default: 600 seconds / 10 minutes)"
    },

    "oauth2": {
      "_description": "OAuth2 token management settings",

      "token_refresh_buffer_seconds": 300,
      "_token_refresh_buffer_seconds_doc": "Refresh tokens this many seconds before expiry (default: 300 = 5 minutes, prevents expiry during use)",

      "token_cache_ttl_seconds": 3300,
      "_token_cache_ttl_seconds_doc": "Cache OAuth2 access tokens for this many seconds (default: 3300 = 55 min, matches token lifetime with 5-min buffer)",

      "token_default_lifetime_seconds": 3600,
      "_token_default_lifetime_seconds_doc": "Default token lifetime if provider doesn't specify (default: 3600 = 1 hour)"
    },

    "http_pool": {
      "_description": "HTTP connection pool for OAuth2 API requests",

      "total_connections": 500,
      "_total_connections_doc": "Maximum total HTTP connections across all hosts (default: 500)",

      "connections_per_host": 100,
      "_connections_per_host_doc": "Maximum connections per host (Google/Microsoft OAuth2 endpoints) (default: 100)",

      "dns_cache_ttl_seconds": 300,
      "_dns_cache_ttl_seconds_doc": "DNS cache TTL in seconds (default: 300 = 5 minutes)",

      "connect_timeout_seconds": 5,
      "_connect_timeout_seconds_doc": "Timeout for establishing HTTP connection (default: 5 seconds)",

      "max_retries": 3,
      "_max_retries_doc": "Maximum HTTP request retries on transient failures (default: 3)"
    },

    "smtp": {
      "_description": "SMTP protocol settings",

      "server_hostname": "xoauth2-proxy",
      "_server_hostname_doc": "SMTP server name advertised in EHLO responses (default: xoauth2-proxy)",

      "max_message_size": 52428800,
      "_max_message_size_doc": "Maximum message size in bytes (default: 52428800 = 50 MB)",

      "max_recipients": 1000,
      "_max_recipients_doc": "Maximum recipients per message (default: 1000)",

      "max_line_length": 1000,
      "_max_line_length_doc": "Maximum SMTP command line length (default: 1000, RFC 5321 recommends 512)",

      "use_source_ip_binding": true,
      "_use_source_ip_binding_doc": "Enable source IP binding for outbound SMTP connections (default: true, allows using multiple server IPs)",

      "validate_source_ip": true,
      "_validate_source_ip_doc": "Validate that IP addresses exist on server before using (default: true, prevents config errors)",

      "use_ipv6": false,
      "_use_ipv6_doc": "Use IPv6 addresses for sending (default: false, most providers work better with IPv4)"
    },

    "logging": {
      "_description": "Logging configuration",

      "level": "INFO",
      "_level_doc": "Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL (default: INFO)",

      "format": "%(asctime)s - %(name)s - %(levelname)s - [%(threadName)s] - %(message)s",
      "_format_doc": "Log message format (Python logging format)",

      "log_file_override": null,
      "_log_file_override_doc": "Override default log file path (default: null, uses platform-specific path)",

      "console_output": true,
      "_console_output_doc": "Enable console (stdout) logging in addition to file (default: true)"
    }
  },

  "providers": {
    "_description": "Provider-specific defaults for Gmail, Outlook, and fallback",

    "gmail": {
      "_description": "Gmail (smtp.gmail.com:587) default settings",

      "oauth_token_url": "https://oauth2.googleapis.com/token",
      "_oauth_token_url_doc": "OAuth2 token refresh endpoint for Gmail",

      "smtp_endpoint": "smtp.gmail.com:587",
      "_smtp_endpoint_doc": "Default SMTP endpoint for Gmail accounts",

      "max_concurrent_messages": 15,
      "_max_concurrent_messages_doc": "Maximum concurrent messages per account (default: 15, Gmail has generous rate limits)",

      "connection_pool": {
        "_description": "Connection pool settings for Gmail accounts",

        "max_connections_per_account": 20,
        "_max_connections_per_account_doc": "Maximum concurrent SMTP connections per account (default: 40, HIGH-VOLUME: 20 for faster reuse)",

        "max_messages_per_connection": 200,
        "_max_messages_per_connection_doc": "Maximum messages before closing connection (default: 50, HIGH-VOLUME: 200 for better reuse)",

        "connection_max_age_seconds": 300,
        "_connection_max_age_seconds_doc": "Maximum connection lifetime in seconds (default: 600, HIGH-VOLUME: 300 = 5 minutes)",

        "connection_idle_timeout_seconds": 30,
        "_connection_idle_timeout_seconds_doc": "Idle timeout before closing connection (default: 120, HIGH-VOLUME: 30 seconds)",

        "adaptive_prewarm_enabled": true,
        "_adaptive_prewarm_enabled_doc": "Enable adaptive pre-warming based on traffic patterns (default: true, replaces fixed percentage pre-warming)",

        "prewarm_min_connections": 1,
        "_prewarm_min_connections_doc": "Minimum connections to pre-warm for every active account (default: 1, ensures <100ms latency on cold start)",

        "prewarm_max_connections": 10,
        "_prewarm_max_connections_doc": "Maximum connections to pre-warm per account (default: 10, scales based on traffic)",

        "prewarm_min_message_threshold": 100,
        "_prewarm_min_message_threshold_doc": "Only pre-warm accounts that sent >100 messages in last hour (default: 100, prevents wasting resources on inactive accounts)",

        "prewarm_messages_per_connection": 10,
        "_prewarm_messages_per_connection_doc": "Tuning parameter: connections = messages_per_hour / 60 / this_value (default: 10, lower=more_connections, higher=fewer_connections)",

        "prewarm_concurrent_tasks": 100,
        "_prewarm_concurrent_tasks_doc": "Maximum concurrent connection creations during startup (default: 100, prevents memory spike)",

        "idle_connection_reuse_timeout": 120,
        "_idle_connection_reuse_timeout_doc": "Consider connection idle after N seconds and create replacement on-demand (default: 120, detects stale connections)"
      },

      "rate_limiting": {
        "_description": "Rate limiting settings for Gmail accounts",

        "enabled": true,
        "_enabled_doc": "Enable rate limiting (default: true)",

        "messages_per_hour": 10000,
        "_messages_per_hour_doc": "Maximum messages per hour per account (default: 10000, Gmail limit ~2000/day)",

        "messages_per_minute_per_connection": 25,
        "_messages_per_minute_per_connection_doc": "Maximum messages per minute per connection (default: 25)",

        "burst_size": 50,
        "_burst_size_doc": "Burst allowance for token bucket algorithm (default: 50)"
      },

      "retry": {
        "_description": "Retry settings for transient Gmail failures",

        "max_attempts": 2,
        "_max_attempts_doc": "Maximum retry attempts for failed operations (default: 2)",

        "backoff_factor": 2.0,
        "_backoff_factor_doc": "Exponential backoff multiplier (default: 2.0, delays: 1s, 2s, 4s, ...)",

        "max_delay_seconds": 30,
        "_max_delay_seconds_doc": "Maximum retry delay in seconds (default: 30)",

        "jitter_enabled": true,
        "_jitter_enabled_doc": "Add random jitter to retry delays to avoid thundering herd (default: true)"
      },

      "circuit_breaker": {
        "_description": "Circuit breaker to prevent cascading failures to Gmail",

        "enabled": true,
        "_enabled_doc": "Enable circuit breaker (default: true)",

        "failure_threshold": 5,
        "_failure_threshold_doc": "Consecutive failures before opening circuit (default: 5)",

        "recovery_timeout_seconds": 60,
        "_recovery_timeout_seconds_doc": "Seconds before attempting half-open state (default: 60)",

        "half_open_max_calls": 2,
        "_half_open_max_calls_doc": "Test calls in half-open state before closing circuit (default: 2)"
      }
    },

    "outlook": {
      "_description": "Outlook (smtp.office365.com:587) default settings",

      "oauth_token_url": "https://login.microsoftonline.com/common/oauth2/v2.0/token",
      "_oauth_token_url_doc": "OAuth2 token refresh endpoint for Outlook/Office365",

      "smtp_endpoint": "smtp.office365.com:587",
      "_smtp_endpoint_doc": "Default SMTP endpoint for Outlook accounts",

      "max_concurrent_messages": 12,
      "_max_concurrent_messages_doc": "Maximum concurrent messages per account (default: 12, Outlook has stricter rate limits)",

      "connection_pool": {
        "_description": "Connection pool settings for Outlook accounts",

        "max_connections_per_account": 15,
        "_max_connections_per_account_doc": "Maximum concurrent SMTP connections per account (default: 30, HIGH-VOLUME: 15 for faster reuse)",

        "max_messages_per_connection": 150,
        "_max_messages_per_connection_doc": "Maximum messages before closing connection (default: 40, HIGH-VOLUME: 150 for better reuse)",

        "connection_max_age_seconds": 240,
        "_connection_max_age_seconds_doc": "Maximum connection lifetime in seconds (default: 300, HIGH-VOLUME: 240 = 4 minutes)",

        "connection_idle_timeout_seconds": 30,
        "_connection_idle_timeout_seconds_doc": "Idle timeout before closing connection (default: 60, HIGH-VOLUME: 30 seconds)",

        "adaptive_prewarm_enabled": true,
        "_adaptive_prewarm_enabled_doc": "Enable adaptive pre-warming based on traffic patterns (default: true, replaces fixed percentage pre-warming)",

        "prewarm_min_connections": 1,
        "_prewarm_min_connections_doc": "Minimum connections to pre-warm for every active account (default: 1, ensures <100ms latency on cold start)",

        "prewarm_max_connections": 8,
        "_prewarm_max_connections_doc": "Maximum connections to pre-warm per account (default: 8, lower than Gmail due to stricter Outlook limits)",

        "prewarm_min_message_threshold": 100,
        "_prewarm_min_message_threshold_doc": "Only pre-warm accounts that sent >100 messages in last hour (default: 100, prevents wasting resources on inactive accounts)",

        "prewarm_messages_per_connection": 10,
        "_prewarm_messages_per_connection_doc": "Tuning parameter: connections = messages_per_hour / 60 / this_value (default: 10, lower=more_connections, higher=fewer_connections)",

        "prewarm_concurrent_tasks": 100,
        "_prewarm_concurrent_tasks_doc": "Maximum concurrent connection creations during startup (default: 100, prevents memory spike)",

        "idle_connection_reuse_timeout": 120,
        "_idle_connection_reuse_timeout_doc": "Consider connection idle after N seconds and create replacement on-demand (default: 120, detects stale connections)"
      },

      "rate_limiting": {
        "_description": "Rate limiting settings for Outlook accounts",

        "enabled": true,
        "_enabled_doc": "Enable rate limiting (default: true)",

        "messages_per_hour": 10000,
        "_messages_per_hour_doc": "Maximum messages per hour per account (default: 10000, Outlook limit ~10000/day)",

        "messages_per_minute_per_connection": 15,
        "_messages_per_minute_per_connection_doc": "Maximum messages per minute per connection (default: 15, Outlook is stricter)",

        "burst_size": 30,
        "_burst_size_doc": "Burst allowance for token bucket algorithm (default: 30)"
      },

      "retry": {
        "_description": "Retry settings for transient Outlook failures",

        "max_attempts": 2,
        "_max_attempts_doc": "Maximum retry attempts for failed operations (default: 2)",

        "backoff_factor": 2.0,
        "_backoff_factor_doc": "Exponential backoff multiplier (default: 2.0)",

        "max_delay_seconds": 30,
        "_max_delay_seconds_doc": "Maximum retry delay in seconds (default: 30)",

        "jitter_enabled": true,
        "_jitter_enabled_doc": "Add random jitter to retry delays (default: true)"
      },

      "circuit_breaker": {
        "_description": "Circuit breaker to prevent cascading failures to Outlook",

        "enabled": true,
        "_enabled_doc": "Enable circuit breaker (default: true)",

        "failure_threshold": 5,
        "_failure_threshold_doc": "Consecutive failures before opening circuit (default: 5)",

        "recovery_timeout_seconds": 60,
        "_recovery_timeout_seconds_doc": "Seconds before attempting half-open state (default: 60)",

        "half_open_max_calls": 2,
        "_half_open_max_calls_doc": "Test calls in half-open state before closing circuit (default: 2)"
      }
    },

    "default": {
      "_description": "Default settings for unknown/custom providers",

      "max_concurrent_messages": 10,
      "_max_concurrent_messages_doc": "Maximum concurrent messages per account (default: 10, conservative for unknown providers)",

      "connection_pool": {
        "_description": "Connection pool settings for default/custom providers",

        "max_connections_per_account": 30,
        "_max_connections_per_account_doc": "Maximum concurrent SMTP connections per account (default: 30)",

        "max_messages_per_connection": 50,
        "_max_messages_per_connection_doc": "Maximum messages before closing connection (default: 50)",

        "connection_max_age_seconds": 300,
        "_connection_max_age_seconds_doc": "Maximum connection lifetime in seconds (default: 300 = 5 minutes)",

        "connection_idle_timeout_seconds": 60,
        "_connection_idle_timeout_seconds_doc": "Idle timeout before closing connection (default: 60 seconds)",

        "adaptive_prewarm_enabled": true,
        "_adaptive_prewarm_enabled_doc": "Enable adaptive pre-warming based on traffic patterns (default: true)",

        "prewarm_min_connections": 1,
        "_prewarm_min_connections_doc": "Minimum connections to pre-warm for every active account (default: 1)",

        "prewarm_max_connections": 8,
        "_prewarm_max_connections_doc": "Maximum connections to pre-warm per account (default: 8)",

        "prewarm_min_message_threshold": 100,
        "_prewarm_min_message_threshold_doc": "Only pre-warm accounts that sent >100 messages in last hour (default: 100)",

        "prewarm_messages_per_connection": 10,
        "_prewarm_messages_per_connection_doc": "Tuning parameter: connections = messages_per_hour / 60 / this_value (default: 10)",

        "prewarm_concurrent_tasks": 100,
        "_prewarm_concurrent_tasks_doc": "Maximum concurrent connection creations during startup (default: 100)",

        "idle_connection_reuse_timeout": 120,
        "_idle_connection_reuse_timeout_doc": "Consider connection idle after N seconds and create replacement on-demand (default: 120)"
      },

      "rate_limiting": {
        "enabled": true,
        "messages_per_hour": 5000,
        "messages_per_minute_per_connection": 20,
        "burst_size": 40
      },

      "retry": {
        "max_attempts": 2,
        "backoff_factor": 2.0,
        "max_delay_seconds": 30,
        "jitter_enabled": true
      },

      "circuit_breaker": {
        "enabled": true,
        "failure_threshold": 5,
        "recovery_timeout_seconds": 60,
        "half_open_max_calls": 2
      }
    }
  },

  "_usage_notes": {
    "1": "This file contains ONLY global settings and provider defaults",
    "2": "Account credentials (emails, OAuth2 tokens) go in accounts.json (separate file)",
    "3": "CLI arguments override these settings: --host, --port, --admin-host, --admin-port, --global-concurrency, --dry-run",
    "4": "Individual accounts can override provider defaults in accounts.json using optional fields",
    "5": "Send SIGHUP signal (Unix) to hot-reload configuration without restarting: kill -HUP <pid>",
    "6": "Windows does not support SIGHUP - restart required for config changes",
    "7": "See docs/DEPLOYMENT_GUIDE.md for production configuration recommendations",
    "8": "ADAPTIVE PRE-WARMING (v2.0): Connections now scale based on actual traffic, not fixed percentages. See 'adaptive_prewarm_enabled' and 'prewarm_max_connections' fields",
    "9": "DEPRECATED FIELDS (kept for backward compatibility but not used): prewarm_percentage, periodic_rewarm_enabled, periodic_rewarm_interval_seconds, rewarm_concurrent_tasks in src/config/proxy_config.py"
  }
}
