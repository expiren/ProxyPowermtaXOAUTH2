# PowerMTA v6 Configuration with XOAUTH2 Proxy
# Supports both Gmail and Outlook/Office365 with 20 accounts (10 Gmail + 10 Outlook)
# Last Updated: 2025-11-14

# =====================================================================
# GLOBAL SETTINGS
# =====================================================================
job-class default
max-connections 100
max-connections-per-source 10
binding-rate-limit 100000
max-multithreading-degree 8


# =====================================================================
# LOGGING CONFIGURATION
# =====================================================================
log-file /var/log/pmta/pmta.log size=100M rotation=20

<bounce-log pmta-bounces>
  filename /var/log/pmta/bounces.log
  record-all-bounces yes
  output-format detailed
</bounce-log>

<bounce-log pmta-failures>
  filename /var/log/pmta/failures.log
  output-format detailed
</bounce-log>

<smtp-source pmta-smtp>
  port 25
  max-connections 1000
  max-connections-per-source 100
  log-connections yes
  max-message-size 52428800
</smtp-source>

<smtp-source pmta-smtp-auth>
  port 587
  max-connections 500
  max-connections-per-source 50
  allow-auth yes
  log-connections yes
  max-message-size 52428800
</smtp-source>


# =====================================================================
# VIRTUAL-MTA CONFIGURATION (20 accounts: 10 Gmail + 10 Outlook)
# Each with dedicated IP (192.168.1.100-192.168.1.119)
# =====================================================================

# Gmail VMTAs (10 accounts)
<virtual-mta vmta-gmail-user1>
  smtp-source-host 192.168.1.100
</virtual-mta>

<virtual-mta vmta-gmail-user2>
  smtp-source-host 192.168.1.101
</virtual-mta>

<virtual-mta vmta-gmail-user3>
  smtp-source-host 192.168.1.102
</virtual-mta>

<virtual-mta vmta-gmail-user4>
  smtp-source-host 192.168.1.103
</virtual-mta>

<virtual-mta vmta-gmail-user5>
  smtp-source-host 192.168.1.104
</virtual-mta>

<virtual-mta vmta-gmail-user6>
  smtp-source-host 192.168.1.105
</virtual-mta>

<virtual-mta vmta-gmail-user7>
  smtp-source-host 192.168.1.106
</virtual-mta>

<virtual-mta vmta-gmail-user8>
  smtp-source-host 192.168.1.107
</virtual-mta>

<virtual-mta vmta-gmail-user9>
  smtp-source-host 192.168.1.108
</virtual-mta>

<virtual-mta vmta-gmail-user10>
  smtp-source-host 192.168.1.109
</virtual-mta>

# Outlook VMTAs (10 accounts)
<virtual-mta vmta-outlook-user1>
  smtp-source-host 192.168.1.110
</virtual-mta>

<virtual-mta vmta-outlook-user2>
  smtp-source-host 192.168.1.111
</virtual-mta>

<virtual-mta vmta-outlook-user3>
  smtp-source-host 192.168.1.112
</virtual-mta>

<virtual-mta vmta-outlook-user4>
  smtp-source-host 192.168.1.113
</virtual-mta>

<virtual-mta vmta-outlook-user5>
  smtp-source-host 192.168.1.114
</virtual-mta>

<virtual-mta vmta-outlook-user6>
  smtp-source-host 192.168.1.115
</virtual-mta>

<virtual-mta vmta-outlook-user7>
  smtp-source-host 192.168.1.116
</virtual-mta>

<virtual-mta vmta-outlook-user8>
  smtp-source-host 192.168.1.117
</virtual-mta>

<virtual-mta vmta-outlook-user9>
  smtp-source-host 192.168.1.118
</virtual-mta>

<virtual-mta vmta-outlook-user10>
  smtp-source-host 192.168.1.119
</virtual-mta>


# =====================================================================
# DOMAIN CONFIGURATION
# =====================================================================

<domain gmail.com>
  bounce-log pmta-bounces
  failure-log pmta-failures
  use-dkim yes
  dkim-signer-domain gmail.com
  dkim-private-key-file /etc/pmta/dkim/gmail.key
</domain>

<domain outlook.com>
  bounce-log pmta-bounces
  failure-log pmta-failures
  use-dkim yes
  dkim-signer-domain outlook.com
  dkim-private-key-file /etc/pmta/dkim/outlook.key
</domain>

<domain hotmail.com>
  bounce-log pmta-bounces
  failure-log pmta-failures
  use-dkim yes
  dkim-signer-domain hotmail.com
  dkim-private-key-file /etc/pmta/dkim/outlook.key
</domain>

<domain default>
  bounce-log pmta-bounces
  failure-log pmta-failures
  max-delivery-attempts 10
  attempt-interval 15m
</domain>


# =====================================================================
# ROUTES TO XOAUTH2 PROXY (127.0.0.1:2525)
# Gmail Routes (10 accounts)
# =====================================================================

<route gmail-user1>
  virtual-mta vmta-gmail-user1
  domain gmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username gmail.account1@gmail.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route gmail-user2>
  virtual-mta vmta-gmail-user2
  domain gmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username gmail.account2@gmail.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route gmail-user3>
  virtual-mta vmta-gmail-user3
  domain gmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username gmail.account3@gmail.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route gmail-user4>
  virtual-mta vmta-gmail-user4
  domain gmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username gmail.account4@gmail.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route gmail-user5>
  virtual-mta vmta-gmail-user5
  domain gmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username gmail.account5@gmail.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route gmail-user6>
  virtual-mta vmta-gmail-user6
  domain gmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username gmail.account6@gmail.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route gmail-user7>
  virtual-mta vmta-gmail-user7
  domain gmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username gmail.account7@gmail.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route gmail-user8>
  virtual-mta vmta-gmail-user8
  domain gmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username gmail.account8@gmail.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route gmail-user9>
  virtual-mta vmta-gmail-user9
  domain gmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username gmail.account9@gmail.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route gmail-user10>
  virtual-mta vmta-gmail-user10
  domain gmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username gmail.account10@gmail.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>


# =====================================================================
# ROUTES TO XOAUTH2 PROXY (127.0.0.1:2525)
# Outlook Routes (10 accounts) - for outlook.com, hotmail.com domains
# =====================================================================

<route outlook-user1>
  virtual-mta vmta-outlook-user1
  domain outlook.com
  domain hotmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username outlook.account1@outlook.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route outlook-user2>
  virtual-mta vmta-outlook-user2
  domain outlook.com
  domain hotmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username outlook.account2@outlook.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route outlook-user3>
  virtual-mta vmta-outlook-user3
  domain outlook.com
  domain hotmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username outlook.account3@outlook.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route outlook-user4>
  virtual-mta vmta-outlook-user4
  domain outlook.com
  domain hotmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username outlook.account4@outlook.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route outlook-user5>
  virtual-mta vmta-outlook-user5
  domain outlook.com
  domain hotmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username outlook.account5@outlook.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route outlook-user6>
  virtual-mta vmta-outlook-user6
  domain outlook.com
  domain hotmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username outlook.account6@outlook.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route outlook-user7>
  virtual-mta vmta-outlook-user7
  domain outlook.com
  domain hotmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username outlook.account7@outlook.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route outlook-user8>
  virtual-mta vmta-outlook-user8
  domain outlook.com
  domain hotmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username outlook.account8@outlook.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route outlook-user9>
  virtual-mta vmta-outlook-user9
  domain outlook.com
  domain hotmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username outlook.account9@outlook.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>

<route outlook-user10>
  virtual-mta vmta-outlook-user10
  domain outlook.com
  domain hotmail.com
  smtp-host 127.0.0.1 port=2525
  auth-username outlook.account10@outlook.com
  auth-password placeholder
  max-smtp-out 10
  max-smtp-connections 5
</route>


# =====================================================================
# DEFAULT ROUTE (non-gmail/non-outlook domains)
# =====================================================================

<route default>
  max-smtp-out 100
  max-smtp-connections 20
</route>


# =====================================================================
# PERFORMANCE TUNING
# =====================================================================
dns-cache-ttl 300
dns-parallel-queries 4
queue-checkpoint-interval 60m
queue-dump-directory /var/spool/pmta/queue

<performance-settings>
  queue-cache-memory 100
  max-workers 32
</performance-settings>


# =====================================================================
# SECURITY & POLICY
# =====================================================================
<policy auth-policy>
  relay-allowed
</policy>

<policy default-policy>
  relay-allowed
</policy>

# End of PMTA Configuration for Gmail + Outlook with XOAUTH2 Proxy
